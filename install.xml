<?xml version="1.0"?>
<!DOCTYPE modification SYSTEM "http://www.simplemachines.org/xml/modification">
<modification xmlns="http://www.simplemachines.org/xml/modification" xmlns:smf="http://www.simplemachines.org/">
	<id>Sorunome:instructions</id>
	<version>0.1</version>

	<file name="$boarddir/index.php">
		<operation>
			<search position="before"><![CDATA[		'im' => array('PersonalMessage.php', 'MessageMain'),
]]></search>
			<add><![CDATA[		'instructions' => array('Instructions.php', 'InstructionsMain'),
]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[// Clean the request variables, add slashes, etc.
cleanRequest();
]]></search>
			<add><![CDATA[//check for pretty urls to add the instructions hook
if(!empty($modSettings['pretty_enable_filters'])){
	$cbs = unserialize($modSettings['pretty_filter_callbacks']);
	$cbs[] = 'Instructions_pretty_filter';
	$modSettings['pretty_filter_callbacks'] = serialize($cbs);
	function Instructions_pretty_filter($urls){
		global $boardurl, $context, $modSettings, $scripturl;
		
		$pattern = '`' . $scripturl . '(.*)action=([^;]+)`S';
		$replacement = $boardurl . '/$2/$1';
		foreach ($urls as $url_id => $url){
			if (!isset($url['replacement']))
				if(preg_match('`'.$scripturl.'(.*)action=instructions;id=([^;]+);step=([^;]+);stepname=([^;]+)`S',$url['url'],$matches)){
					$urls[$url_id]['replacement'] = preg_replace('`'.$scripturl.'(.*)action=instructions;id=([^;]+);step=([^;]+);stepname=([^;]+)`S',$boardurl.'/instructions/$2/step$3/$4/$1', $url['url']);
				}elseif(preg_match('`'.$scripturl.'(.*)action=instructions;id=([^;]+);step=([^;]+)`S',$url['url'],$matches)){
					$urls[$url_id]['replacement'] = preg_replace('`'.$scripturl.'(.*)action=instructions;id=([^;]+);step=([^;]+)`S',$boardurl.'/instructions/$2/step$3/$1', $url['url']);
				}elseif(preg_match('`'.$scripturl.'(.*)action=instructions;id=([^;]+)`S',$url['url'],$matches)){
					$urls[$url_id]['replacement'] = preg_replace('`'.$scripturl.'(.*)action=instructions;id=([^;]+)`S',$boardurl.'/instructions/$2/$1', $url['url']);
				}elseif(preg_match('`'.$scripturl.'(.*)action=instructions`S',$url['url'],$matches)){
					$urls[$url_id]['replacement'] = preg_replace('`'.$scripturl.'(.*)action=instructions`S',$boardurl.'/instructions/$1', $url['url']);
				}
		}
		
		return $urls;
	}
}]]></add>
		</operation>
	</file>

	

	<file name="$sourcedir/Subs.php">
		<operation>
			<search position="after"><![CDATA[			'mlist' => array(
				'title' => $txt['members_title'],
]]></search>
			<add><![CDATA[			'instructions' => array(
				'title' => $txt['instructions'],
				'href' => $scripturl . '?action=instructions',
				'show' => true,
				'sub_buttons' => array(
					'new' => array(
						'title' => $txt['instructions_new'],
						'href' => $scripturl . '?action=instructions;new',
						'show' => allowedTo('inst_can_edit_own') || allowedTo('inst_can_edit_any'),
						'is_last' => true
					)
				),
			),
]]></add>
		</operation>
	</file>

	<file name="$languagedir/Modifications.english.php">
		<operation>
			<search position="end" />
			<add><![CDATA[// Instructions
$txt['instructions'] = 'Instructions';
$txt['instructions_new'] = 'New Instruction';
$txt['instruction_cant_view'] = 'Cannot view instruction, insufficient permissions!';
$txt['instruction_cant_edit'] = 'Cannot edit instruction, insufficient permissions!';
$txt['instruction_not_found'] = 'Instruction not found!';
]]></add>
		</operation>
	</file>
	
	
	<file name="$languagedir/ManagePermissions.english.php">
		<operation>
			
			<search position="end" />
			
			<add><![CDATA[
$txt['permissiongroup_instructions'] = 'Instructions';
$txt['permissiongroup_simple_instructions'] = 'Instructions';
$txt['permissionname_inst_can_delete'] = 'Allowed to delete instructions:';
$txt['permissionname_inst_can_view_published'] = 'Allowed to view <b>published</b> instructions:';
$txt['permissionname_inst_can_view_unpublished'] = 'Allowed to view <b>unpublished</b> instructions:';
$txt['permissionname_inst_can_edit'] = 'Allowed to edit instructions:';
$txt['permissionname_inst_can_delete_own'] = 'Own instruction';
$txt['permissionname_inst_can_delete_any'] = 'Any instruction';
$txt['permissionname_inst_can_view_unpublished_own'] = 'Own instruction';
$txt['permissionname_inst_can_view_unpublished_any'] = 'Any instruction';
$txt['permissionname_inst_can_edit_own'] = 'Own instruction';
$txt['permissionname_inst_can_edit_any'] = 'Any instruction';
$txt['permissionname_inst_publish_instruction'] = 'Allowed to post instructions';
]]></add>
		</operation>
	</file>
	
	
	<file name="$sourcedir/ManagePermissions.php">
		<operation>
			<search position="before"><![CDATA[
			'simple' => array(
]]></search>
			<add><![CDATA[
			'instructions',
]]></search>
		</operation>
		<operation>
			<search position="before"><![CDATA[
			'classic' => array(
]]></search>
			<add><![CDATA[
			'instructions',
]]></search>
		</operation>
		<operation>
			<search position="before"><![CDATA[
	$permissionList = array(
		'membergroup' => array(
]]></search>
			
			<add><![CDATA[			'inst_can_delete' => array(true, 'instructions', 'instructions'),
			'inst_can_view_published' => array(false, 'instructions', 'instructions'),
			'inst_can_view_unpublished' => array(true, 'instructions', 'instructions'),
			'inst_can_edit' => array(true, 'instructions', 'instructions'),]]></add>
		</operation>
		<operation>
			<search position="after"><![CDATA[
			'moderate_board' => array(false, 'general_board', 'moderate'),]]></search>
			<add><![CDATA[
			'inst_publish_instruction' => array(false, 'instructions', 'instructions'),]]></add>
		</operation>
	</file>
	
	<file name="$sourcedir/Profile-View.php">
		<operation>
		
			<search position="before"><![CDATA[
	loadCustomFields($memID);
]]></search>
			<add><![CDATA[
	loadTemplate('Instructions');
	include_once($sourcedir . '/Instructions.php');
	InstructionsLoadProfile($memID);
]]></add>
		</operation>
	</file>
	
	<file name="$themedir/Profile.template.php">
		<operation>
			<search position="replace"><![CDATA[<div id="profileview" class="flow_auto">]]></search>
			<add><![CDATA[<div id="profileview" class="no_flow_auto">]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[	// Show the users signature.
	if ($context['signature_enabled'] && !empty($context['member']['signature']))
		echo '
				<div class="signature">
					<h5>', $txt['signature'], ':</h5>
					', $context['member']['signature'], '
				</div>';

	echo '
			</div>
			<span class="botslice"><span></span></span>
		</div>
	</div>
<div class="clear"></div>]]></search>
			<add><![CDATA[';
if(function_exists('getInstructionsTable')){
	echo '<div id="instructions_table_profile"><div class="cat_bar"><h3 class="catbg"><span class="ie6_header floatleft">'.$txt['instructions'].'</span></h3></div>';
	getInstructionsTable($context['instructions']);
	echo '</div>';
}
echo ']]></add>
		</operation>
	</file>
	<file name="$themedir/css/index.css">
		<operation>
			<search position="end" />
			<add><![CDATA[
#instructions_table_profile {
	margin: 5px 0 0 0;
	float: right;
	width: 79.5%;
}
#main_admsection #instructions_table_profile {
	width:100%;
}
]]></add>
		</operation>
	</file>
<!--
	<file name="$sourcedir/Admin.php">
		<operation>
			<search position="before"><![CDATA[						// Note the comma!! The setting with automatically appear with the first mod to be added.]]></search>
			<add><![CDATA[
						'recenttopics' => array($txt['recent_topics']),]]></add>
		</operation>
		<operation>
			<search position="before"><![CDATA[		// Mod authors if you want to be "real freaking good" then add any setting pages for your mod BELOW this line!]]></search>
			<add><![CDATA[
		array('ModifyRecentTopics', 'area=modsettings;sa=recenttopics'),]]></add>
		</operation>
	</file>

	<file name="$sourcedir/ManageSettings.php">
		<operation>
			<search position="before"><![CDATA[		// Mod authors, once again, if you have a whole section to add do it AFTER this line, and keep a comma at the end.]]></search>
			<add><![CDATA[
		'recenttopics' => 'ModifyRecentTopics',]]></add>
		</operation>
		<operation>
			<search position="end" />
			<add><![CDATA[// Modify AJAX Recent Topics
function ModifyRecentTopics($return_config = false)
{
	global $txt, $scripturl, $context, $modSettings, $sc, $modSettings;

	$config_vars = array(
		array('int', 'number_recent_topics'),
		array('int', 'number_recent_topics_interval', 3, 'subtext' => $txt['number_recent_topics_interval_desc']),
	);

	if ($return_config)
		return $config_vars;

	$context['post_url'] = $scripturl . '?action=admin;area=modsettings;save;sa=recenttopics';
	$context['settings_title'] = $txt['recent_topics'];

	if (isset($_GET['save']))
	{
		checkSession();
		saveDBSettings($config_vars);
		redirectexit('action=admin;area=modsettings;sa=recenttopics');
	}

	prepareDBSettingContext($config_vars);
}
]]></add>
		</operation>
	</file>-->

</modification>
